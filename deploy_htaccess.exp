#!/usr/bin/expect -f

# Script pour déployer la configuration .htaccess mise à jour
set timeout 30

# Connexion SSH
spawn ssh ZDaULDMYSEC_sam@57-104359.ssh.hosting-ik.com
expect "password:"
send "35G0ke7I@Fz%~T\r"

# Aller dans le répertoire du site
expect "$ "
send "cd /srv/customer/sites/fusepoint.ch\r"

# Sauvegarder l'ancien .htaccess (échapper le $ pour que le shell distant l'expanse)
expect "$ "
send "cp .htaccess .htaccess.backup.\$(date +%Y%m%d_%H%M%S)\r"

# Afficher le contenu actuel pour comparaison
expect "$ "
send "echo '=== ANCIEN .htaccess ==='\r"
expect "$ "
send "cat .htaccess\r"

expect "$ "
send "echo '=== NOUVEAU .htaccess ==='\r"

# Créer le nouveau .htaccess avec la configuration de proxy et la CSP
expect "$ "
send "cat > .htaccess << 'EOF'\r"
send "# Fusepoint Platform - Routing et headers pour SPA sous /app\r"
send "RewriteEngine On\r"
send "\r"
send "# CORS et préflight pour l'API (utilisable en .htaccess via SetEnvIf + Header)\r"
send "SetEnvIf Request_URI \"^/api/\" IS_API=1\r"
send "RewriteCond %{REQUEST_METHOD} OPTIONS\r"
send "RewriteCond %{REQUEST_URI} ^/api/\r"
send "RewriteRule ^ - \[R=200,L\]\r"
send "\r"
send "# En-têtes CORS pour l'API\r"
send "Header always set Access-Control-Allow-Origin \"https://fusepoint.ch\" env=IS_API\r"
send "Header always set Access-Control-Allow-Methods \"GET, POST, PUT, DELETE, OPTIONS\" env=IS_API\r"
send "Header always set Access-Control-Allow-Headers \"Content-Type, Authorization, X-Requested-With\" env=IS_API\r"
send "Header always set Access-Control-Allow-Credentials \"true\" env=IS_API\r"
send "\r"
send "# Proxy pour les requêtes API vers le backend Node.js\r"
send "ProxyPreserveHost On\r"
send "ProxyPass /api/ http://localhost:3000/api/\r"
send "ProxyPassReverse /api/ http://localhost:3000/api/\r"
send "\r"
send "# Séparer API et certaines ressources des réécritures SPA\r"
send "RewriteCond %{REQUEST_URI} ^/api/ \[OR\]\r"
send "RewriteCond %{REQUEST_URI} ^/uploads/\r"
send "RewriteRule ^ - \[L\]\r"
send "RewriteCond %{REQUEST_URI} ^/public/lotties/\r"
send "RewriteRule ^ - \[L\]\r"
send "RewriteCond %{REQUEST_URI} ^/uploads/lotties/\r"
send {RewriteRule ^uploads/lotties/(.*)$ public/lotties/$1 [L]\r}
send "RewriteRule ^public/lotties/ - \[L\]\r"
send "\r"
send "# SPA: routes /app/* -> /dist/app/index.html et assets vers /dist/assets\r"
send "RewriteCond %{REQUEST_FILENAME} !-f\r"
send "RewriteCond %{REQUEST_FILENAME} !-d\r"
send "RewriteCond %{REQUEST_URI} ^/app/\r"
send {RewriteRule app/assets/(.*)$ /dist/assets/$1 [L]\r}
send "RewriteRule ^app/.*$ /dist/app/index.html \[L,E=IS_SPA:1\]\r"
send "\r"
send "# Landing: toutes les autres routes non-fichiers -> index.html\r"
send "RewriteCond %{REQUEST_FILENAME} !-f\r"
send "RewriteCond %{REQUEST_FILENAME} !-d\r"
send "RewriteRule ^.*$ /index.html \[L\]\r"
send "\r"
send "# Headers de sécurité basiques\r"
send "Header always set X-Content-Type-Options nosniff\r"
send "Header always set X-Frame-Options DENY\r"
send "Header always set X-XSS-Protection \"1; mode=block\"\r"
send "Header always set Referrer-Policy \"strict-origin-when-cross-origin\"\r"
send "\r"
send "# Politique de Sécurité de Contenu (CSP)\r"
send "Header always unset Content-Security-Policy\r"
send "Header always set Content-Security-Policy \"default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://unpkg.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://*.lottiefiles.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com https://cdn.jsdelivr.net 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; connect-src 'self' https://api.openai.com https://*.googleapis.com; frame-src 'self' https://player.vimeo.com https://www.youtube.com\"\r"
send "\r"
send "# Désactiver le cache pour l'index SPA servi via /app/*\r"
send "Header set Cache-Control \"no-cache, no-store, must-revalidate\" env=IS_SPA\r"
send "Header set Pragma \"no-cache\" env=IS_SPA\r"
send "\r"
send "# Cache pour assets statiques\r"
send "<FilesMatch \"\\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$\">\r"
send "  ExpiresActive On\r"
send "  ExpiresDefault \"access plus 1 month\"\r"
send "  Header append Cache-Control \"public\"\r"
send "</FilesMatch>\r"
send "\r"
send "# No-cache pour les HTML\r"
send "<FilesMatch \"^(index\\.html|app/index\\.html)$\">\r"
send "  ExpiresActive On\r"
send "  ExpiresDefault \"access plus 0 seconds\"\r"
send "  Header set Cache-Control \"no-cache, no-store, must-revalidate\"\r"
send "  Header set Pragma \"no-cache\"\r"
send "</FilesMatch>\r"
send "\r"
send "# Forcer le type MIME JSON pour les .json\r"
send "AddType application/json .json\r"
send "EOF\r"

# Vérifier le nouveau contenu
expect "$ "
send "cat .htaccess\r"

# Appliquer également la CSP dans dist/ et dist/app/ pour les réponses statiques
expect "$ "
send "mkdir -p dist/app\r"
expect "$ "
send "cat > dist/.htaccess << 'EOF2'\r"
send "# CSP appliquée au répertoire dist (réponses statiques)\r"
send "Header always unset Content-Security-Policy\r"
send "Header always set Content-Security-Policy \"default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://unpkg.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://*.lottiefiles.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com https://cdn.jsdelivr.net 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; connect-src 'self' https://api.openai.com https://*.googleapis.com; frame-src 'self' https://player.vimeo.com https://www.youtube.com\"\r"
send "EOF2\r"
expect "$ "
send "cat > dist/app/.htaccess << 'EOF3'\r"
send "# CSP appliquée au répertoire dist/app (SPA)\r"
send "Header always unset Content-Security-Policy\r"
send "Header always set Content-Security-Policy \"default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://unpkg.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://*.lottiefiles.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com https://cdn.jsdelivr.net 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; connect-src 'self' https://api.openai.com https://*.googleapis.com; frame-src 'self' https://player.vimeo.com https://www.youtube.com\"\r"
send "EOF3\r"

# Tester une requête API
expect "$ "
send "echo '=== TEST API ==='\r"
expect "$ "
send "curl -I http://localhost/api/health 2>/dev/null || echo 'Test API échoué'\r"

expect "$ "
send "echo 'Configuration .htaccess déployée avec succès !'\r"

# Quitter la session proprement
expect "$ "
send "exit\r"
expect eof