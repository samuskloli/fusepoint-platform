#!/bin/bash

# =============================================================================
# FUSEPOINT PLATFORM - GESTIONNAIRE PRINCIPAL
# =============================================================================
# Script centralis√© pour toutes les op√©rations de la plateforme Fusepoint
# Remplace tous les scripts √©parpill√©s par une interface unifi√©e
#
# Usage: ./fusepoint-manager.sh [category] [action] [options]
#
# Auteur: Assistant IA
# Version: 1.0
# Date: $(date +%Y-%m-%d)
# =============================================================================

set -e

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
# R√©soudre le lien symbolique pour obtenir le vrai chemin du script
SCRIPT_PATH="${BASH_SOURCE[0]}"
if [ -L "$SCRIPT_PATH" ]; then
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
fi
PROJECT_ROOT="$(cd "$(dirname "$SCRIPT_PATH")" && cd ../.. && pwd)"
SERVER_DIR="$PROJECT_ROOT/server"
BACKUP_SCRIPT="$PROJECT_ROOT/scripts/backup-system.cjs"
DB_PATH="$PROJECT_ROOT/server/database/fusepoint.db"

# Fonctions utilitaires
log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

log_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

log_header() {
    echo -e "${PURPLE}üöÄ $1${NC}"
    echo -e "${PURPLE}$(printf '=%.0s' {1..60})${NC}"
}

# =============================================================================
# GESTION DES SERVEURS
# =============================================================================

server_start() {
    log_header "D√©marrage des serveurs Fusepoint"
    
    cd "$PROJECT_ROOT"
    
    # V√©rifier si les serveurs sont d√©j√† en cours
    if pgrep -f "vite" > /dev/null || pgrep -f "server.js" > /dev/null; then
        log_warning "Des serveurs sont d√©j√† en cours d'ex√©cution"
        server_status
        return
    fi
    
    log_info "D√©marrage du serveur backend..."
    cd "$SERVER_DIR"
    nohup node server.js > ../logs/backend.log 2>&1 &
    BACKEND_PID=$!
    echo $BACKEND_PID > ../logs/backend.pid
    
    log_info "D√©marrage du serveur frontend..."
    cd "$PROJECT_ROOT"
    nohup npm run dev > logs/frontend.log 2>&1 &
    FRONTEND_PID=$!
    echo $FRONTEND_PID > logs/frontend.pid
    
    sleep 3
    server_status
    log_success "Serveurs d√©marr√©s avec succ√®s"
}

server_stop() {
    log_header "Arr√™t des serveurs Fusepoint"
    
    # Arr√™ter les processus par PID
    if [ -f "$PROJECT_ROOT/logs/backend.pid" ]; then
        BACKEND_PID=$(cat "$PROJECT_ROOT/logs/backend.pid")
        if kill -0 $BACKEND_PID 2>/dev/null; then
            kill $BACKEND_PID
            log_info "Backend arr√™t√© (PID: $BACKEND_PID)"
        fi
        rm -f "$PROJECT_ROOT/logs/backend.pid"
    fi
    
    if [ -f "$PROJECT_ROOT/logs/frontend.pid" ]; then
        FRONTEND_PID=$(cat "$PROJECT_ROOT/logs/frontend.pid")
        if kill -0 $FRONTEND_PID 2>/dev/null; then
            kill $FRONTEND_PID
            log_info "Frontend arr√™t√© (PID: $FRONTEND_PID)"
        fi
        rm -f "$PROJECT_ROOT/logs/frontend.pid"
    fi
    
    # Nettoyage suppl√©mentaire
    pkill -f "node.*server.js" 2>/dev/null || true
    pkill -f "vite" 2>/dev/null || true
    
    log_success "Tous les serveurs ont √©t√© arr√™t√©s"
}

server_restart() {
    log_header "Red√©marrage des serveurs Fusepoint"
    server_stop
    sleep 2
    server_start
}

server_status() {
    log_header "√âtat des serveurs Fusepoint"
    
    # V√©rifier le backend
    if pgrep -f "server.js" > /dev/null; then
        BACKEND_PID=$(pgrep -f "server.js")
        log_success "Backend: En cours (PID: $BACKEND_PID)"
        
        # Test de connectivit√©
        if curl -s http://localhost:3000/api/health > /dev/null 2>&1; then
            log_success "API Backend: Accessible"
        else
            log_warning "API Backend: Non accessible"
        fi
    else
        log_error "Backend: Arr√™t√©"
    fi
    
    # V√©rifier le frontend
    if pgrep -f "vite" > /dev/null; then
        FRONTEND_PID=$(pgrep -f "vite")
        log_success "Frontend: En cours (PID: $FRONTEND_PID)"
        
        # Test de connectivit√©
        if curl -s http://localhost:8080 > /dev/null 2>&1 || curl -s http://localhost:3000 > /dev/null 2>&1; then
            log_success "Frontend: Accessible sur http://localhost:8080 ou http://localhost:3000"
        else
            log_warning "Frontend: Non accessible"
        fi
    else
        log_error "Frontend: Arr√™t√©"
    fi
}

# =============================================================================
# GESTION DES SAUVEGARDES
# =============================================================================

backup_create() {
    local type=${1:-full}
    log_header "Cr√©ation d'une sauvegarde $type"
    
    if [ -f "$BACKUP_SCRIPT" ]; then
        node "$BACKUP_SCRIPT" create --type="$type"
    else
        log_error "Script de sauvegarde non trouv√©: $BACKUP_SCRIPT"
        exit 1
    fi
}

backup_list() {
    log_header "Liste des sauvegardes"
    
    if [ -f "$BACKUP_SCRIPT" ]; then
        node "$BACKUP_SCRIPT" list
    else
        log_error "Script de sauvegarde non trouv√©: $BACKUP_SCRIPT"
        exit 1
    fi
}

backup_restore() {
    local backup_id="$1"
    if [ -z "$backup_id" ]; then
        log_error "ID de sauvegarde requis"
        backup_list
        exit 1
    fi
    
    log_header "Restauration de la sauvegarde: $backup_id"
    
    if [ -f "$BACKUP_SCRIPT" ]; then
        node "$BACKUP_SCRIPT" restore "$backup_id"
    else
        log_error "Script de sauvegarde non trouv√©: $BACKUP_SCRIPT"
        exit 1
    fi
}

# =============================================================================
# GESTION DE LA BASE DE DONN√âES
# =============================================================================

db_status() {
    log_header "√âtat de la base de donn√©es"
    
    if [ -f "$DB_PATH" ]; then
        local size=$(du -h "$DB_PATH" | cut -f1)
        log_success "Base de donn√©es: $DB_PATH ($size)"
        
        # Test de connectivit√©
        if sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM sqlite_master;" > /dev/null 2>&1; then
            local tables=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM sqlite_master WHERE type='table';")
            log_success "Tables: $tables tables trouv√©es"
        else
            log_error "Impossible de se connecter √† la base de donn√©es"
        fi
    else
        log_error "Base de donn√©es non trouv√©e: $DB_PATH"
    fi
}

db_export() {
    local output_file="database-backups/export_$(date +%Y%m%d_%H%M%S).sql"
    log_header "Export de la base de donn√©es"
    
    mkdir -p "$(dirname "$output_file")"
    
    if sqlite3 "$DB_PATH" ".dump" > "$output_file"; then
        log_success "Export cr√©√©: $output_file"
    else
        log_error "√âchec de l'export"
        exit 1
    fi
}

# =============================================================================
# D√âPLOIEMENT
# =============================================================================

deploy_production() {
    local branch=${1:-main}
    log_header "D√©ploiement en production (branche: $branch)"
    
    # V√©rifications pr√©alables
    if ! git status > /dev/null 2>&1; then
        log_error "Ce n'est pas un d√©p√¥t Git"
        exit 1
    fi
    
    # Sauvegarde avant d√©ploiement
    log_info "Cr√©ation d'une sauvegarde avant d√©ploiement..."
    backup_create "pre-deploy"
    
    # D√©ploiement
    log_info "D√©ploiement vers le serveur..."
    if [ -f "$PROJECT_ROOT/deploy-to-server.sh" ]; then
        "$PROJECT_ROOT/deploy-to-server.sh" "$branch"
    else
        log_error "Script de d√©ploiement non trouv√©"
        exit 1
    fi
}

# =============================================================================
# D√âVELOPPEMENT
# =============================================================================

dev_setup() {
    log_header "Configuration de l'environnement de d√©veloppement"
    
    # V√©rifier Node.js
    if ! command -v node &> /dev/null; then
        log_error "Node.js n'est pas install√©"
        exit 1
    fi
    
    log_info "Version Node.js: $(node --version)"
    
    # Installer les d√©pendances
    log_info "Installation des d√©pendances..."
    cd "$PROJECT_ROOT"
    npm install
    
    cd "$SERVER_DIR"
    npm install
    
    # Cr√©er les dossiers n√©cessaires
    mkdir -p "$PROJECT_ROOT/logs"
    
    log_success "Environnement de d√©veloppement configur√©"
}

# =============================================================================
# MAINTENANCE
# =============================================================================

maintenance_cleanup() {
    log_header "Nettoyage du syst√®me"
    
    # Nettoyer les logs anciens
    find "$PROJECT_ROOT/logs" -name "*.log" -mtime +7 -delete 2>/dev/null || true
    log_info "Logs anciens supprim√©s"
    
    # Nettoyer les sauvegardes anciennes
    if [ -f "$BACKUP_SCRIPT" ]; then
        node "$BACKUP_SCRIPT" cleanup --days=30
    fi
    
    # Nettoyer les fichiers temporaires
    find "$PROJECT_ROOT" -name "*.tmp" -delete 2>/dev/null || true
    find "$PROJECT_ROOT" -name ".DS_Store" -delete 2>/dev/null || true
    
    log_success "Nettoyage termin√©"
}

maintenance_health() {
    log_header "Rapport de sant√© du syst√®me"
    
    # √âtat des serveurs
    server_status
    echo
    
    # √âtat de la base de donn√©es
    db_status
    echo
    
    # Espace disque
    log_info "Espace disque utilis√©:"
    du -sh "$PROJECT_ROOT" 2>/dev/null || true
    
    # Derni√®re sauvegarde
    if [ -f "$BACKUP_SCRIPT" ]; then
        echo
        log_info "Derni√®res sauvegardes:"
        node "$BACKUP_SCRIPT" list | tail -3
    fi
}

# =============================================================================
# INTERFACE PRINCIPALE
# =============================================================================

show_help() {
    echo -e "${CYAN}üöÄ Fusepoint Platform - Gestionnaire Principal${NC}"
    echo -e "${CYAN}================================================${NC}"
    echo
    echo "Usage: $0 [category] [action] [options]"
    echo
    echo -e "${YELLOW}üìÇ CAT√âGORIES DISPONIBLES:${NC}"
    echo
    echo -e "${GREEN}server${NC}     - Gestion des serveurs"
    echo "  start              D√©marrer les serveurs"
    echo "  stop               Arr√™ter les serveurs"
    echo "  restart            Red√©marrer les serveurs"
    echo "  status             Voir l'√©tat des serveurs"
    echo
    echo -e "${GREEN}backup${NC}     - Gestion des sauvegardes"
    echo "  create [type]      Cr√©er une sauvegarde (full/config/database)"
    echo "  list               Lister les sauvegardes"
    echo "  restore <id>       Restaurer une sauvegarde"
    echo
    echo -e "${GREEN}database${NC}   - Gestion de la base de donn√©es"
    echo "  status             √âtat de la base de donn√©es"
    echo "  export             Exporter la base de donn√©es"
    echo
    echo -e "${GREEN}deploy${NC}     - D√©ploiement"
    echo "  production [branch] D√©ployer en production"
    echo
    echo -e "${GREEN}dev${NC}        - D√©veloppement"
    echo "  setup              Configurer l'environnement de d√©veloppement"
    echo
    echo -e "${GREEN}maintenance${NC} - Maintenance"
    echo "  cleanup            Nettoyer le syst√®me"
    echo "  health             Rapport de sant√©"
    echo
    echo -e "${YELLOW}üìã EXEMPLES:${NC}"
    echo "  $0 server start"
    echo "  $0 backup create full"
    echo "  $0 deploy production main"
    echo "  $0 maintenance health"
    echo
}

# =============================================================================
# POINT D'ENTR√âE PRINCIPAL
# =============================================================================

main() {
    local category="$1"
    local action="$2"
    local option="$3"
    
    case "$category" in
        "server")
            case "$action" in
                "start") server_start ;;
                "stop") server_stop ;;
                "restart") server_restart ;;
                "status") server_status ;;
                *) log_error "Action inconnue: $action"; show_help; exit 1 ;;
            esac
            ;;
        "backup")
            case "$action" in
                "create") backup_create "$option" ;;
                "list") backup_list ;;
                "restore") backup_restore "$option" ;;
                *) log_error "Action inconnue: $action"; show_help; exit 1 ;;
            esac
            ;;
        "database"|"db")
            case "$action" in
                "status") db_status ;;
                "export") db_export ;;
                *) log_error "Action inconnue: $action"; show_help; exit 1 ;;
            esac
            ;;
        "deploy")
            case "$action" in
                "production") deploy_production "$option" ;;
                *) log_error "Action inconnue: $action"; show_help; exit 1 ;;
            esac
            ;;
        "dev")
            case "$action" in
                "setup") dev_setup ;;
                *) log_error "Action inconnue: $action"; show_help; exit 1 ;;
            esac
            ;;
        "maintenance")
            case "$action" in
                "cleanup") maintenance_cleanup ;;
                "health") maintenance_health ;;
                *) log_error "Action inconnue: $action"; show_help; exit 1 ;;
            esac
            ;;
        "help"|"--help"|"-h"|"")
            show_help
            ;;
        *)
            log_error "Cat√©gorie inconnue: $category"
            show_help
            exit 1
            ;;
    esac
}

# Ex√©cuter le script
main "$@"