#!/usr/bin/expect -f

# CrÃ©e (ou remplace) le script test-email.js sur le serveur distant

set timeout 120
set user "ZDaULDMYSEC_sam"
set host "57-104359.ssh.hosting-ik.com"
set pass "35G0ke7I@Fz%~T"
set remote "$user@$host"
set docroot "/srv/customer/sites/fusepoint.ch"

spawn ssh -o StrictHostKeyChecking=accept-new $remote {cat > '/srv/customer/sites/fusepoint.ch/server/test-email.js' << 'EOF'
const fs = require('fs');
const path = require('path');
const envPath = path.join(__dirname, '.env');
if (fs.existsSync(envPath)) {
  const lines = fs.readFileSync(envPath, 'utf8').split('\n');
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed && !trimmed.startsWith('#')) {
      const idx = trimmed.indexOf('=');
      if (idx > 0) {
        const key = trimmed.slice(0, idx).trim();
        let val = trimmed.slice(idx + 1).trim();
        if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith('\'') && val.endsWith('\''))) {
          val = val.slice(1, -1);
        }
        process.env[key] = val;
      }
    }
  }
}
const EmailService = require('./services/emailService.js');
(async () => {
  const svc = new EmailService();
  const res = await svc.testEmailConfiguration();
  console.log(JSON.stringify(res));
})().catch(e => { console.error('SMTP test failed:', e && e.message ? e.message : e); process.exit(1); });
EOF}
expect {
  -re ".*password:" { send "$pass\r" }
}
expect eof